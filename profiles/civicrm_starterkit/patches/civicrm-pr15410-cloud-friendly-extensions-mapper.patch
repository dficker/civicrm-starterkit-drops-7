From 9194bdb32f8aed4fcb3724d3c9b22b7179f0d8e4 Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Sun, 6 Oct 2019 16:19:14 -0400
Subject: [PATCH 1/6] only store full_name but still make it backwards
 compatible

---
 CRM/Extension/Mapper.php | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index fd828e4fe77..3aeb3a28254 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -304,7 +304,7 @@ public function getActiveModuleFiles($fresh = FALSE) {
         try {
           $moduleExtensions[] = [
             'prefix' => $dao->file,
-            'filePath' => $this->keyToPath($dao->full_name),
+            'filePath' => $dao->full_name,
           ];
         }
         catch (CRM_Extension_Exception $e) {
@@ -323,6 +323,12 @@ public function getActiveModuleFiles($fresh = FALSE) {
         $this->cache->set($this->cacheKey . '_moduleFiles', $moduleExtensions);
       }
     }
+
+    // Since we're not caching the full path we add it now.
+    array_walk($moduleExtensions, function(&$value, $key) {
+      $value['filePath'] = $this->keyToPath($value['filePath']);
+    });
+
     return $moduleExtensions;
   }
 

From 0851bac5e682aed90fb1a7c57f40e22ae74ba09e Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Mon, 7 Oct 2019 09:37:34 -0400
Subject: [PATCH 2/6] move the try catch

---
 CRM/Extension/Mapper.php | 32 +++++++++++++++-----------------
 1 file changed, 15 insertions(+), 17 deletions(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index 3aeb3a28254..df38b02fff0 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -301,22 +301,11 @@ public function getActiveModuleFiles($fresh = FALSE) {
         if (!empty($compat[$dao->full_name]['force-uninstall'])) {
           continue;
         }
-        try {
-          $moduleExtensions[] = [
-            'prefix' => $dao->file,
-            'filePath' => $dao->full_name,
-          ];
-        }
-        catch (CRM_Extension_Exception $e) {
-          // Putting a stub here provides more consistency
-          // in how getActiveModuleFiles when racing between
-          // dirty file-removals and cache-clears.
-          CRM_Core_Session::setStatus($e->getMessage(), '', 'error');
-          $moduleExtensions[] = [
-            'prefix' => $dao->file,
-            'filePath' => NULL,
-          ];
-        }
+        $moduleExtensions[] = [
+          'prefix' => $dao->file,
+          'fullName' => $dao->full_name,
+          'filePath' => NULL,
+        ];
       }
 
       if ($this->cache) {
@@ -326,7 +315,16 @@ public function getActiveModuleFiles($fresh = FALSE) {
 
     // Since we're not caching the full path we add it now.
     array_walk($moduleExtensions, function(&$value, $key) {
-      $value['filePath'] = $this->keyToPath($value['filePath']);
+      try {
+        $value['filePath'] = $this->keyToPath($value['fullName']);
+      }
+      catch (CRM_Extension_Exception $e) {
+        // Putting a stub here provides more consistency
+        // in how getActiveModuleFiles when racing between
+        // dirty file-removals and cache-clears.
+        CRM_Core_Session::setStatus($e->getMessage(), '', 'error');
+        $value['filePath'] = NULL;
+      }
     });
 
     return $moduleExtensions;

From 7382e21642212abb1659d16e7ef0717884ff1c70 Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Mon, 7 Oct 2019 13:42:24 -0400
Subject: [PATCH 3/6] make moduleExtensions a static variable

---
 CRM/Extension/Mapper.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index df38b02fff0..f554daca2a2 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -280,7 +280,7 @@ public function getActiveModuleFiles($fresh = FALSE) {
       return [];
     }
 
-    $moduleExtensions = NULL;
+    static $moduleExtensions = NULL;
     if ($this->cache && !$fresh) {
       $moduleExtensions = $this->cache->get($this->cacheKey . '_moduleFiles');
     }

From 456e90978d99ed48144aaa0a7cbf52e8d6da7803 Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Wed, 9 Oct 2019 09:29:49 -0400
Subject: [PATCH 4/6] only try to build filePath if empty

---
 CRM/Extension/Mapper.php | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index f554daca2a2..1b939fe0c73 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -316,7 +316,9 @@ public function getActiveModuleFiles($fresh = FALSE) {
     // Since we're not caching the full path we add it now.
     array_walk($moduleExtensions, function(&$value, $key) {
       try {
-        $value['filePath'] = $this->keyToPath($value['fullName']);
+        if (!$value['filePath']) {
+          $value['filePath'] = $this->keyToPath($value['fullName']);
+        }
       }
       catch (CRM_Extension_Exception $e) {
         // Putting a stub here provides more consistency

From 0e092fe0de9bb485171395c4b28dbfd96939c24f Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Tue, 5 Nov 2019 20:43:43 -0500
Subject: [PATCH 5/6] improve storing and referencing from static variable

---
 CRM/Extension/Mapper.php | 21 +++++++++++++++++++--
 1 file changed, 19 insertions(+), 2 deletions(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index 1b939fe0c73..c88dae6eba7 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -272,7 +272,7 @@ public function keyToUrl($key) {
    * @param bool $fresh
    *   whether to forcibly reload extensions list from canonical store.
    * @return array
-   *   array(array('prefix' => $, 'file' => $))
+   *   array(array('prefix' => $, 'fullName' => $, 'filePath' => $))
    */
   public function getActiveModuleFiles($fresh = FALSE) {
     if (!defined('CIVICRM_DSN')) {
@@ -280,11 +280,26 @@ public function getActiveModuleFiles($fresh = FALSE) {
       return [];
     }
 
-    static $moduleExtensions = NULL;
+    // The list of module files is cached in two tiers. The tiers are slightly
+    // different:
+    //
+    // 1. The persistent tier (cache) stores
+    // names WITHOUT absolute paths.
+    // 2. The ephemeral/thread-local tier (statics) stores names
+    // WITH absolute paths.
+    // Return static value instead of re-running query
+    if (isset(Civi::$statics[__CLASS__]['moduleExtensions'])) {
+      return Civi::$statics[__CLASS__]['moduleExtensions'];
+    }
+
+    $moduleExtensions = NULL;
+
+    // Checked if it's stored in the persistent cache.
     if ($this->cache && !$fresh) {
       $moduleExtensions = $this->cache->get($this->cacheKey . '_moduleFiles');
     }
 
+    // If cache is empty we build it from database.
     if (!is_array($moduleExtensions)) {
       $compat = CRM_Extension_System::getCompatibilityInfo();
 
@@ -329,6 +344,8 @@ public function getActiveModuleFiles($fresh = FALSE) {
       }
     });
 
+    Civi::$statics[__CLASS__]['moduleExtensions'] = $moduleExtensions;
+
     return $moduleExtensions;
   }
 

From 24ef6b4903d2cd77534a994dbec5cbc300409250 Mon Sep 17 00:00:00 2001
From: Herb vd Dool <herb@3speedhub.com>
Date: Wed, 6 Nov 2019 11:24:17 -0500
Subject: [PATCH 6/6] if fresh variable set then skip static too

---
 CRM/Extension/Mapper.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/CRM/Extension/Mapper.php b/CRM/Extension/Mapper.php
index c88dae6eba7..be2fe57b430 100644
--- a/CRM/Extension/Mapper.php
+++ b/CRM/Extension/Mapper.php
@@ -288,7 +288,7 @@ public function getActiveModuleFiles($fresh = FALSE) {
     // 2. The ephemeral/thread-local tier (statics) stores names
     // WITH absolute paths.
     // Return static value instead of re-running query
-    if (isset(Civi::$statics[__CLASS__]['moduleExtensions'])) {
+    if (isset(Civi::$statics[__CLASS__]['moduleExtensions']) && !$fresh) {
       return Civi::$statics[__CLASS__]['moduleExtensions'];
     }
 
